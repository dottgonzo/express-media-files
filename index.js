"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var mediawatch = require("mediawatch");
var express = require("express");
var bodyParser = require("body-parser");
var jwt = require("jsonwebtoken");
function default_1(path, config) {
    var mode = 'rootuser';
    var secret = false;
    if (config) {
        if (config.mode && config.mode.type === 'users' && config.mode.secret) {
            secret = config.mode.secret;
            mode = 'users';
        }
    }
    else {
        config = {};
    }
    var router = express.Router();
    var fflist = new mediawatch.mediafiles({ path: path, exclude: config.exclude, serverUri: config.serverUri });
    router.use(bodyParser.json());
    router.use(bodyParser.urlencoded({ extended: true }));
    function getFilesByToken(token, list) {
        try {
            var decoded = jwt.verify(token, config.mode.secret, { ignoreExpiration: config.mode.ignoreExpiration });
            var prefix = decoded.prefix;
            var correctedList = [];
            for (var i = 0; i < list.length; i++) {
                var item = list[i];
                if (item.name.split(prefix).length > 1 && item.name.split(prefix)[0] === '') {
                    correctedList.push(item);
                }
            }
            return correctedList;
        }
        catch (err) {
            return false;
        }
    }
    router.get('/list', function (req, res) {
        if (mode === 'rootuser') {
            res.json({ list: fflist.list });
        }
        else {
            res.json({ error: 'rootmode not allowed' });
        }
    });
    router.get('/listjs', function (req, res) {
        if (mode === 'rootuser') {
            res.send('var list=' + JSON.stringify(fflist.list));
        }
        else {
            res.send("alert('user mode not allowed')");
        }
    });
    router.get('/user/:token/list', function (req, res) {
        if (mode !== 'users') {
            res.json({ error: 'mode users' });
        }
        else {
            var byToken = getFilesByToken(req.params.token, fflist.list);
            if (byToken) {
                res.json({ list: byToken });
            }
            else {
                res.json({ error: 'json not valid' });
            }
        }
    });
    router.get('/user/:token/listjs', function (req, res) {
        if (mode === 'users') {
            var byToken = getFilesByToken(req.params.token, fflist.list);
            if (byToken) {
                res.send('var list=' + JSON.stringify(byToken));
            }
            else {
                res.json({ error: 'json not valid' });
            }
        }
        else {
            res.json({ error: 'mode users' });
        }
    });
    router.get('/ping', function (req, res) {
        res.json({ pong: 'ok' });
    });
    return router;
}
exports.default = default_1;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFDLENBQUE7SUFHRixNQUFNLENBQUMsR0FBRyxDQUFDLHFCQUFxQixFQUFFLFVBQVUsR0FBRyxFQUFFLEdBQUc7UUFDbEQsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDckIsSUFBTSxPQUFPLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUM5RCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNaLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtZQUNqRCxDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxnQkFBZ0IsRUFBRSxDQUFDLENBQUE7WUFDdkMsQ0FBQztRQUNILENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUNuQyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxVQUFVLEdBQUcsRUFBRSxHQUFHO1FBQ3BDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQTtJQUMxQixDQUFDLENBQUMsQ0FBQTtJQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUE7QUFDZixDQUFDO0FBOUZELDRCQThGQyIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIG1lZGlhd2F0Y2ggZnJvbSAnbWVkaWF3YXRjaCdcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnXG5pbXBvcnQgKiBhcyBleHByZXNzIGZyb20gJ2V4cHJlc3MnXG5pbXBvcnQgKiBhcyBib2R5UGFyc2VyIGZyb20gJ2JvZHktcGFyc2VyJ1xuaW1wb3J0ICogYXMgIGp3dCBmcm9tICdqc29ud2VidG9rZW4nXG5cblxuaW50ZXJmYWNlIElNZWRpYUZpbGVSZXNwIHtcbiAgbWV0YTogSU1lZGlhRmlsZU1ldGFcbiAgZHVyYXRpb246IHN0cmluZ1xuICBwYXRoOiBzdHJpbmdcbiAgZnVsbG5hbWU6IHN0cmluZ1xuICBuYW1lOiBzdHJpbmdcbiAgZXh0ZW5zaW9uOiBzdHJpbmdcbiAgZGlyOiBzdHJpbmdcbiAgZXh0ZW5zaW9uRmFtaWx5OiBzdHJpbmdcbiAgZXh0ZW5zaW9uVHlwZTogc3RyaW5nXG4gIHVpZDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBJTWVkaWFGaWxlTWV0YSB7XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gKHBhdGgsIGNvbmZpZz86IHsgZXhjbHVkZT86c3RyaW5nW10sIHNlcnZlclVyaT86IHsgcGF0aDogc3RyaW5nLCB1cmk6IHN0cmluZyB9LCBtb2RlPzogeyB0eXBlOiBzdHJpbmcsIHNlY3JldD86IHN0cmluZywgaWdub3JlRXhwaXJhdGlvbj86IHRydWUgfSB9KSB7XG5cbiAgbGV0IG1vZGUgPSAncm9vdHVzZXInXG4gIGxldCBzZWNyZXQ6IGFueSA9IGZhbHNlXG4gIGlmIChjb25maWcpIHtcbiAgICBpZiAoY29uZmlnLm1vZGUgJiYgY29uZmlnLm1vZGUudHlwZSA9PT0gJ3VzZXJzJyAmJiBjb25maWcubW9kZS5zZWNyZXQpIHtcbiAgICAgIHNlY3JldCA9IGNvbmZpZy5tb2RlLnNlY3JldFxuICAgICAgbW9kZSA9ICd1c2VycydcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uZmlnPXt9XG4gIH1cblxuXG4gIGNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG5cbiAgY29uc3QgZmZsaXN0ID0gbmV3IG1lZGlhd2F0Y2gubWVkaWFmaWxlcyh7IHBhdGg6IHBhdGgsIGV4Y2x1ZGU6Y29uZmlnLmV4Y2x1ZGUsIHNlcnZlclVyaTogY29uZmlnLnNlcnZlclVyaSB9KVxuXG5cbiAgcm91dGVyLnVzZShib2R5UGFyc2VyLmpzb24oKSlcbiAgcm91dGVyLnVzZShib2R5UGFyc2VyLnVybGVuY29kZWQoeyBleHRlbmRlZDogdHJ1ZSB9KSlcblxuXG4gIC8vIHVzZSByZXMucmVuZGVyIHRvIGxvYWQgdXAgYW4gZWpzIHZpZXcgZmlsZVxuXG5cbiAgZnVuY3Rpb24gZ2V0RmlsZXNCeVRva2VuKHRva2VuLCBsaXN0OiBJTWVkaWFGaWxlUmVzcFtdKTogSU1lZGlhRmlsZVJlc3BbXSB8IGZhbHNlIHtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBkZWNvZGVkID0gand0LnZlcmlmeSh0b2tlbiwgY29uZmlnLm1vZGUuc2VjcmV0LCB7IGlnbm9yZUV4cGlyYXRpb246IGNvbmZpZy5tb2RlLmlnbm9yZUV4cGlyYXRpb24gfSlcbiAgICAgIGNvbnN0IHByZWZpeDogc3RyaW5nID0gZGVjb2RlZC5wcmVmaXhcbiAgICAgIGNvbnN0IGNvcnJlY3RlZExpc3Q6IElNZWRpYUZpbGVSZXNwW10gPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsaXN0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBsaXN0W2ldXG4gICAgICAgIGlmIChpdGVtLm5hbWUuc3BsaXQocHJlZml4KS5sZW5ndGggPiAxICYmIGl0ZW0ubmFtZS5zcGxpdChwcmVmaXgpWzBdID09PSAnJykge1xuICAgICAgICAgIGNvcnJlY3RlZExpc3QucHVzaChpdGVtKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gY29ycmVjdGVkTGlzdFxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG5cbiAgfVxuICByb3V0ZXIuZ2V0KCcvbGlzdCcsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGlmIChtb2RlID09PSAncm9vdHVzZXInKSB7XG4gICAgICByZXMuanNvbih7IGxpc3Q6IGZmbGlzdC5saXN0IH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5qc29uKHsgZXJyb3I6ICdyb290bW9kZSBub3QgYWxsb3dlZCcgfSlcbiAgICB9XG4gIH0pXG4gIHJvdXRlci5nZXQoJy9saXN0anMnLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBpZiAobW9kZSA9PT0gJ3Jvb3R1c2VyJykge1xuICAgICAgcmVzLnNlbmQoJ3ZhciBsaXN0PScgKyBKU09OLnN0cmluZ2lmeShmZmxpc3QubGlzdCkpXG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5zZW5kKFwiYWxlcnQoJ3VzZXIgbW9kZSBub3QgYWxsb3dlZCcpXCIpXG4gICAgfVxuICB9KVxuXG5cblxuICByb3V0ZXIuZ2V0KCcvdXNlci86dG9rZW4vbGlzdCcsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIGlmIChtb2RlICE9PSAndXNlcnMnKSB7XG4gICAgICByZXMuanNvbih7IGVycm9yOiAnbW9kZSB1c2VycycgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYnlUb2tlbiA9IGdldEZpbGVzQnlUb2tlbihyZXEucGFyYW1zLnRva2VuLCBmZmxpc3QubGlzdClcbiAgICAgIGlmIChieVRva2VuKSB7XG4gICAgICAgIHJlcy5qc29uKHsgbGlzdDogYnlUb2tlbiB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzLmpzb24oeyBlcnJvcjogJ2pzb24gbm90IHZhbGlkJyB9KVxuICAgICAgfVxuICAgIH1cbiAgfSlcblxuXG4gIHJvdXRlci5nZXQoJy91c2VyLzp0b2tlbi9saXN0anMnLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBpZiAobW9kZSA9PT0gJ3VzZXJzJykge1xuICAgICAgY29uc3QgYnlUb2tlbiA9IGdldEZpbGVzQnlUb2tlbihyZXEucGFyYW1zLnRva2VuLCBmZmxpc3QubGlzdClcbiAgICAgIGlmIChieVRva2VuKSB7XG4gICAgICAgIHJlcy5zZW5kKCd2YXIgbGlzdD0nICsgSlNPTi5zdHJpbmdpZnkoYnlUb2tlbikpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXMuanNvbih7IGVycm9yOiAnanNvbiBub3QgdmFsaWQnIH0pXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcy5qc29uKHsgZXJyb3I6ICdtb2RlIHVzZXJzJyB9KVxuICAgIH1cbiAgfSlcblxuICByb3V0ZXIuZ2V0KCcvcGluZycsIGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgIHJlcy5qc29uKHsgcG9uZzogJ29rJyB9KVxuICB9KVxuXG4gIHJldHVybiByb3V0ZXJcbn0iXX0=
